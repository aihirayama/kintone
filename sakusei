var sheet = SpreadsheetApp.getActiveSpreadsheet();
//var Sheet1 = sheet.getSheetByName('å…¥åŠ›æ¬„');
var Sheet1 = sheet.getActiveSheet();//ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆã‚’å–å¾—
var Sheet1_name = Sheet1.getSheetName()

//Aåˆ—æœ€çµ‚è¡Œ
var lastrow = Sheet1.getLastRow();
var A_last = Sheet1.getRange(4,1,lastrow,1).getValues().filter(String).length;

//é …ç›®ä½œæˆã‚·ãƒ¼ãƒˆåã®å–å¾—
var sheet_name = Sheet1.getRange('C1').getValues()
var get_sheet= sheet.getSheetByName(sheet_name)


//èµ·å‹•æ™‚ã®å‹•ä½œ
function onOpen() {
  
  if(Sheet1_name === 'ä½¿ã„æ–¹'){
    return;
  }
  
  //ã€Œå…¥åŠ›æ¬„ã€ã‚·ãƒ¼ãƒˆã®è¨­å®š
  Sheet1.getRange('A4:D').clear();//å…¥åŠ›æ¬„ãƒªã‚»ãƒƒãƒˆ
  Sheet1.getRange('C1').clear();//ä»¶åé¸æŠãƒªã‚»ãƒƒãƒˆ
  Sheet1.getRange('C:C').setNumberFormat('@');//å…¥åŠ›æ¬„ã‚’æ–‡å­—åˆ—ã«ã™ã‚‹
  
  //ä»¶åä¸€è¦§è¨­ç½®
  var sheets = SpreadsheetApp.getActiveSpreadsheet().getSheets();
  var sheetnamelist = sheet.getSheetByName('ã‚·ãƒ¼ãƒˆå');
  sheetnamelist.getRange('A:A').clear();//ã€Œã‚·ãƒ¼ãƒˆåã€ãƒªã‚»ãƒƒãƒˆ
  sheetnamelist.getRange('A:A').setNumberFormat('@');//å…¥åŠ›æ¬„ã‚’æ–‡å­—åˆ—ã«ã™ã‚‹
  
  var sheetlist = [];
  var pull_list = ['å…¥åŠ›æ¬„','ä½¿ã„æ–¹','ã‚·ãƒ¼ãƒˆå','å¹³å±±','æˆç”°','ç¹”ç”°','å°å®¤'];
  
  for(var i = 0; i < sheets.length; i++){
    if(pull_list.indexOf(sheets[i].getSheetName()) < 0){
      sheetlist.push([sheets[i].getSheetName()]);
    } 
  } 
    sheetnamelist.getRange(1,1,sheetlist.length,1).setValues(sheetlist);    
}


//å…¥åŠ›ãƒ†ãƒ³ãƒ—ãƒ¬ä½œæˆ
function onEdit(e){
  
  var myCell = sheet.getActiveCell(); //ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒ«ã‚’å–å¾—
  
  if(myCell.getColumn()==3 && myCell.getRow()===1){ //ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒ«ãŒC1åˆ—ã‹ã‚’åˆ¤å®š
    Sheet1.getRange('A4:D').clear();//å…¥åŠ›æ¬„ãƒªã‚»ãƒƒãƒˆ
    
    var mail = get_sheet.getRange('A:A').getValues().filter(String); 
    var ren_item = [];
    
    //å…¥åŠ›é …ç›®æŠ½å‡º
    for(i in mail) {
      if(mail[i][0].match(/\*\*.*?\*\*/)){
        ren_item.push(mail[i][0].match(/\*\*.*?\*\*/g))
      }
    }
    //ä¸€æ¬¡å…ƒé…åˆ—ã«å¤‰æ›
    var ren = Array.prototype.concat.apply([],ren_item).filter(function (x, i, self) { 
      return self.indexOf(x) === i;
    });
    
    //ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå…¥åŠ›å€¤ã®è¨­å®š
    var lastrow = Sheet1.getLastRow();
    var F_last = Sheet1.getRange(4,6,lastrow,1).getValues().filter(String).length;
    var defaultitem = Sheet1.getRange(4,6,F_last,3).getValues();
    
    var items = [];  
    for(i in ren){
      items.push([ren[i],'â†','']) 
      for(x in defaultitem){
        if(items[i][0] == defaultitem[x][0]){
          items[i][2] = defaultitem[x][2]           
        }        
      }
    }
    Sheet1.getRange(4,1,items.length,3).setValues(items);  
  }
}


//ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ä½œæˆ
function create(get_values,Break) { //Breakã¯æ”¹è¡ŒæŒ‡ç¤º
  //ãƒ†ãƒ³ãƒ—ãƒ¬ã‚·ãƒ¼ãƒˆã®æƒ…å ±ã‚’å–å¾— 
  var get_sheet = sheet.getSheetByName(sheet_name);
  var mail_length = get_sheet.getDataRange().getValues().length; 
  var mail = get_sheet.getRange('A6:A' + mail_length).getValues();
 
  //ãƒ†ãƒ³ãƒ—ãƒ¬ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã‚‹
  var mail_text = ''
  for(a in mail){
    mail[a][0] + Break 
    for(i in get_values){
      if(mail[a][0].indexOf(get_values[i][0])>-1){       
        mail[a][0] =  mail[a][0].replace(get_values[i][0],get_values[i][2]);
      } 
    }
    mail_text += mail[a][0] + Break 
  }
  
  return mail_text 

}


//å®›å…ˆä½œæˆ
function mailto(get_values) {
  //  var get_values = Sheet1.getRange(4,1,A_last,4).getValues();
  
  var get_mailto = get_sheet.getRange('A2').getValues()
  var mailto = get_mailto;
  
  for(i in get_values){
    if(get_values[i][0] === get_mailto[0][0]){
      mailto =  get_values[i][2];
      if(get_mailto[0][0] === '**FAXç•ªå·(ãƒã‚¤ãƒ•ãƒ³æœ‰)**'){
        mailto = conversion(mailto).replace( /-/g , "" ) + '@cl1.faximo.jp';
      }
    }
  }
  return mailto
}


//Gmailä¸Šã«ä¸‹æ›¸ãã‚’ä½œã‚‹
function soshin() {
  //C1ãŒé¸æŠã•ã‚Œã¦ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼
  if(A_last < 1){
    return Browser.msgBox('ãƒ¡ãƒ¼ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¸ã‚“ã§ã­ğŸ°');
  }
  
  //å…¥åŠ›æ¬„å–å¾—
  var get_values = Sheet1.getRange(4,1,A_last,4).getValues();
  
  //èƒŒæ™¯è‰²ã®é…åˆ—  
  var h_Backgrounds = Sheet1.getRange(4,1,A_last,4).getBackgrounds();
  
  //ã‚¨ãƒ©ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆ
  var count = 0
  
  //å…¥åŠ›é …ç›®ã®ãƒã‚§ãƒƒã‚¯
  for(i in get_values){ 
    h_Backgrounds[i][2] = '#ffffff';   
    if(get_values[i][2]){
      get_values[i][3] = ''    
    } else {
      count += 1
      get_values[i][3] = 'â†å…¥åŠ›ã—ã¦ã­ğŸ°';
      h_Backgrounds[i][2] = '#fffacd';
      continue
    }       
    if(get_values[i][0] === '**FAXç•ªå·(ãƒã‚¤ãƒ•ãƒ³æœ‰)**'){
      if(get_values[i][2].split('-').length === 3 || get_values[i][2].split('ï¼').length === 3){}
      else{
        count += 1
        h_Backgrounds[i][2] = '#fffacd'
        get_values[i][3] = 'â†ãƒã‚¤ãƒ•ãƒ³ã‚’2ã¤å…¥ã‚Œã¦ã­ğŸ°';           
      }
    }
    if(get_values[i][0] === '**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹(å…ˆæ–¹)**'){
      get_values[i][2] = conversion(get_values[i][2])
      if(get_values[i][2].split('@').length !== 2){
        count += 1
        h_Backgrounds[i][2] = '#fffacd';
        get_values[i][3] = 'â†@ãŒãªã„ã‚ˆğŸ°';
      }
    }   
  }
  
  Sheet1.getRange(4,1,A_last,4).setValues(get_values); 
  Sheet1.getRange(4,1,A_last,4).setBackgrounds(h_Backgrounds);  
  
  if(count === 0){
//    var get_from = get_sheet.getRange('A4').getValues();
    
    //G-mailä½œæˆ
    var mailTo = mailto(get_values)
    var mailTitle = sheet_name[0][0]
    var mailBody = create(get_values,'\n').replace(/é€ä»˜å…ˆï¼š \n/,'').replace(/é€ä»˜å…ˆï¼šã€€\n/,'').replace(/ \n/,'').replace(/ã€€\n/,'');//é€ä»˜å…ˆãŒç©ºç™½ã ã£ãŸã‚‰ã€ŒFAXé€ä»˜æ¡ˆå†…ã€ã‹ã‚‰é€ä»˜å…ˆã‚’æ¶ˆã™ã—ã¦ã€äº‹æ¥­æ‰€ååˆ†ã®ç©ºç™½æ”¹è¡Œã‚’è©°ã‚ã‚‹
    var mailfrom = get_sheet.getRange('A4').getValues()[0][0]  
    
    if(mailTitle.indexOf('**é€ä¿¡è€…**')){
      mailTitle = mailTitle.replace('**é€ä¿¡è€…**',Sheet1_name)
      
    }

//ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä½œæˆ(ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯"cancel")
    var check_mail = '(è¿”ä¿¡ãƒ¡ãƒ¼ãƒ«ã®å ´åˆã¯å¿…è¦ãªã¨ã“ã‚ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ã£ã¦ã­ğŸ°) \\n\\n from: \\n' + mailfrom + '\\n to: \\n' + mailTo 
    + '\\n BCC: \\n jm-sales@medley.jp\\n\\n ä»¶åï¼š \\n' + mailTitle + '\\n\\n\\n' + create(get_values,"\\n").replace(/é€ä»˜å…ˆï¼š \\n/,'').replace(/é€ä»˜å…ˆï¼šã€€\\n/,'').replace(/ \\n/,'').replace(/ã€€\\n/,'');
    var yourSelections = Browser.msgBox('ä¸‹æ›¸ãã‚’Gmailã«åæ˜ ã•ã›ã‚ˆã†ã‹ãªï¼ŸğŸ°',check_mail,Browser.Buttons.YES_NO);
    

    
    
    if(yourSelections === 'yes'){
      
      if(mailto(get_values)[0][0] === '' && mailfrom === ''){
        return Browser.msgBox('ãƒ†ãƒ³ãƒ—ãƒ¬ã®ã‚·ãƒ¼ãƒˆã«To:ã¨From:ãŒãªã„ã‚ˆğŸ°');
      } else if(mailto(get_values)[0][0] === ''){
        return Browser.msgBox('ãƒ†ãƒ³ãƒ—ãƒ¬ã®ã‚·ãƒ¼ãƒˆã«To:ãŒãªã„ã‚ˆğŸ°');
      } else if(mailfrom === ''){
        return Browser.msgBox('ãƒ†ãƒ³ãƒ—ãƒ¬ã®ã‚·ãƒ¼ãƒˆã«From:ãŒãªã„ã‚ˆğŸ°');
      }
      
      createDraft (mailTo,mailTitle,mailBody,mailfrom)      
      Browser.msgBox('G-mailã«ä¸‹æ›¸ãã‚’åæ˜ ã—ãŸã‚ˆğŸ°');      
    }
  } 
}



